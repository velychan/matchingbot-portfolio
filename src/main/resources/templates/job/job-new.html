<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>ê³µê³  ë“±ë¡</title>
    <link rel="stylesheet" th:href="@{/css/company-job.css}"/>
    <link rel="stylesheet" th:href="@{/css/job-new.css}"/>
    <link rel="stylesheet" th:href="@{/css/job-review-modal.css}"/>
    <link rel="stylesheet" th:href="@{/css/spinner-chatbot.css}"/>
</head>
<body>

<div th:replace="~{fragments/header :: header(role=${role})}"></div>

<div th:replace="~{chatbot/job-review-modal :: jobReviewModal}"></div>


<div class="container">
    <h2>ì±„ìš© ê³µê³  ë“±ë¡</h2>

    <form th:action="@{/job/new}" method="post" th:object="${job}">
        <input type="hidden" name="skillKeywordsConcat" id="skillKeywordsConcat"/>
        <input type="hidden" name="traitKeywordsConcat" id="traitKeywordsConcat"/>

        <div class="form-group">
            <label>ê´€ì‹¬ ì§ë¬´</label>
            <input type="hidden" th:field="*{occupationId}" id="occupationId"/>
            <div id="react-job-category-selector"></div>
            <div th:if="${#fields.hasErrors('occupationId')}" class="error-message" th:errors="*{occupationId}"></div>
        </div>

        <div class="form-group">
            <label>ì œëª©</label>
            <input type="text" th:field="*{title}" required/>
            <div th:if="${#fields.hasErrors('title')}" class="error-message" th:errors="*{title}"></div>
        </div>

        <div class="form-group">
            <label>ì„¤ëª…</label>
            <textarea th:field="*{description}" rows="5" required></textarea>
            <div th:if="${#fields.hasErrors('description')}" class="error-message" th:errors="*{description}"></div>
        </div>

        <div class="form-group">
            <label>ì£¼ì†Œ</label>
            <input type="text" th:field="*{address}" required/>
            <div th:if="${#fields.hasErrors('address')}" class="error-message" th:errors="*{address}"></div>
        </div>

        <div class="form-group">
            <label>ì£¼ìš” ì—…ë¬´</label>
            <textarea th:field="*{mainTask}" rows="2" required></textarea>
            <div th:if="${#fields.hasErrors('mainTask')}" class="error-message" th:errors="*{mainTask}"></div>
        </div>

        <!-- í•„ìš” ê¸°ìˆ  -->
        <div class="form-group">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                <label style="margin-bottom: 0;">í•„ìš” ê¸°ìˆ </label>
                <button type="button" onclick="extractKeywords('skill')" class="keyword-button">
                    ğŸ‘‡í‚¤ì›Œë“œ ì¶”ì¶œí•˜ê¸°ğŸ‘‡
                </button>
            </div>
            <textarea id="requiredSkills" name="requiredSkills" class="form-control" rows="3"
                      th:field="*{requiredSkills}"></textarea>
        </div>

        <!-- í•„ìš” ì„±í–¥ -->
        <div class="form-group">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                <label style="margin-bottom: 0;">í•„ìš” ì„±í–¥</label>
                <button type="button" onclick="extractKeywords('trait')" class="keyword-button">
                    ğŸ‘‡í‚¤ì›Œë“œ ì¶”ì¶œí•˜ê¸°ğŸ‘‡
                </button>
            </div>
            <textarea id="requiredTraits" name="requiredTraits" class="form-control" rows="3"
                      th:field="*{requiredTraits}"></textarea>
        </div>

        <div>
            <label><strong>ê¸°ìˆ  í‚¤ì›Œë“œ</strong></label>
            <div id="skill-keyword-wrapper" class="keyword-wrapper">
                <div class="keyword-input">
                    <input type="text" name="skill_keywords[]" placeholder="ê¸°ìˆ  í‚¤ì›Œë“œ"/>
                    <button type="button" class="submit-button" onclick="addSkillKeyword()">+</button>
                </div>
            </div>
        </div>

        <div>
            <label><strong>ì„±í–¥ í‚¤ì›Œë“œ</strong></label>
            <div id="trait-keyword-wrapper" class="keyword-wrapper">
                <div class="keyword-input">
                    <input type="text" name="trait_keywords[]" placeholder="ì„±í–¥ í‚¤ì›Œë“œ"/>
                    <button type="button" class="submit-button" onclick="addTraitKeyword()">+</button>
                </div>
            </div>
            <br>
        </div>

        <input type="hidden" th:field="*{latitude}" value="37.5665"/>
        <input type="hidden" th:field="*{longitude}" value="126.9780"/>

        <div class="form-group">
            <label style="display: block; font-weight: bold;">ì±„ìš© ê¸°ê°„</label>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <input type="date" onclick="this.showPicker()" th:field="*{startDate}" class="form-control"
                           style="width: 100%; cursor: pointer;" required/>
                    <div th:if="${#fields.hasErrors('startDate')}" class="error-message" th:errors="*{startDate}"></div>
                </div>
                <div style="flex: 1;">
                    <input type="date" onclick="this.showPicker()" th:field="*{endDate}" class="form-control"
                           style="width: 100%; cursor: pointer;" required/>
                    <div th:if="${#fields.hasErrors('endDate')}" class="error-message" th:errors="*{endDate}"></div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>ì´ë©”ì¼</label>
            <input type="email" th:field="*{enrollEmail}" required/>
            <div th:if="${#fields.hasErrors('enrollEmail')}" class="error-message" th:errors="*{enrollEmail}"></div>
        </div>

        <div class="form-group">
            <label>ì•ˆë‚´ì‚¬í•­</label>
            <textarea th:field="*{notice}" rows="2"></textarea>
        </div>

        <!--<div class="button-group" style="margin-top: 20px; display: flex; gap: 16px;">
            <button type="submit" class="btn btn-primary">ë“±ë¡</button>
            <button type="button" class="btn btn-primary" onclick="location.href='/job/manage-jobs'">ë“±ë¡ ì·¨ì†Œ</button>
            <button type="button" class="btn btn-secondary" onclick="analyzeJob()">AI ê³µê³ ë¶„ì„</button>
        </div>-->
        <div class="button-group" style="margin-top: 20px; display: flex; gap: 16px;">
            <button type="submit" class="btn btn-primary">ë“±ë¡</button>
            <button type="button" class="btn btn-primary" onclick="location.href='/job/manage-jobs'">ë“±ë¡ ì·¨ì†Œ</button>
            <button type="button" class="btn btn-chatbot" onclick="analyzeJob()">AI ê³µê³ ë¶„ì„</button>
            <button type="button" class="btn btn-outline-secondary" id="restoreBtn" style="display: none;"
                    onclick="restoreOriginalJob()">ë˜ëŒë¦¬ê¸°
            </button>
        </div>
    </form>
</div>

<div id="globalLoadingOverlay" class="overlay" style="display: none;">
    <div class="spinner"></div>
    <div>AI ì œì•ˆ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- ğŸ”½ í•˜ë‹¨ì— script ìœ„ì¹˜ (ê¸°ì¡´ ìœ„ì¹˜ì™€ ê°™ê²Œ ìœ ì§€) -->
<script th:src="@{/js/dropdown.js}"></script>
<script th:src="@{/js/logout.js}"></script>

<!-- React + ReactDOM CDN -->
<script type="module">
    import React from "https://cdn.jsdelivr.net/npm/react@18.2.0/+esm";
    import {createRoot} from "https://cdn.jsdelivr.net/npm/react-dom@18.2.0/client/+esm";

    window.React = React;
    window.createRoot = createRoot;

    // React ì»´í¬ë„ŒíŠ¸ë¥¼ DOMì´ ë¡œë“œëœ ì´í›„ ì‹¤í–‰
    document.addEventListener("DOMContentLoaded", () => {
        import("/js/JobCategorySelector.js").then((mod) => {
            const container = document.getElementById("react-job-category-selector");
            if (container) {
                const root = createRoot(container);
                root.render(React.createElement(mod.default));
            }
        });

        // Form ì œì¶œ ì „ì— occupationId ê°’ì´ ì œëŒ€ë¡œ ë“¤ì–´ê°”ëŠ”ì§€ ê²€ì¦
        const form = document.querySelector("form");
        if (form) {
            form.addEventListener("submit", function (e) {
                const occInput = document.getElementById("occupationId");
                if (!occInput || !occInput.value) {
                    alert("ì§ë¬´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”!");
                    e.preventDefault(); // ì „ì†¡ ë°©ì§€
                } else {
                    console.log("âœ… ì„ íƒëœ occupationId:", occInput.value);
                }
            });
        }
    });
</script>
<script>
    const MAX_KEYWORDS = 15;

    function addKeyword(wrapperId, inputName, placeholderText) {
        const wrapper = document.getElementById(wrapperId);
        const count = wrapper.querySelectorAll('.keyword-input').length;

        if (count >= MAX_KEYWORDS) return;

        // âœ… ê¸°ì¡´ + ë²„íŠ¼ ì œê±° (ìˆë‹¤ë©´)
        const plusButton = Array.from(wrapper.querySelectorAll('button')).find(btn => btn.textContent === '+');
        if (plusButton) {
            plusButton.parentElement.remove(); // div.keyword-input ìì²´ ì‚­ì œ
        }

        // ğŸ”¼ ìƒˆ í‚¤ì›Œë“œ input ì¶”ê°€
        const inputDiv = document.createElement('div');
        inputDiv.className = 'keyword-input';
        inputDiv.innerHTML = `
        <input type="text" name="${inputName}" placeholder="${placeholderText}" />
        <button type="button" onclick="removeKeyword(this)">-</button>
    `;
        wrapper.appendChild(inputDiv);

        // ğŸ”½ + ë²„íŠ¼ ì¬ì‚½ì… (ë§ˆì§€ë§‰ìœ¼ë¡œ)
        if (wrapper.querySelectorAll('.keyword-input').length < MAX_KEYWORDS) {
            const plusDiv = document.createElement('div');
            plusDiv.className = 'keyword-input';

            const input = document.createElement('input');
            input.type = 'text';
            input.name = inputName;
            input.placeholder = placeholderText;

            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = '+';
            button.addEventListener('click', () => {
                addKeyword(wrapperId, inputName, placeholderText);
            });

            plusDiv.appendChild(input);
            plusDiv.appendChild(button);
            wrapper.appendChild(plusDiv);
        }
    }


    function addSkillKeyword() {
        addKeyword('skill-keyword-wrapper', 'skill_keywords[]', 'ê¸°ìˆ  í‚¤ì›Œë“œ');
    }

    function addTraitKeyword() {
        addKeyword('trait-keyword-wrapper', 'trait_keywords[]', 'ì„±í–¥ í‚¤ì›Œë“œ');
    }

    function removeKeyword(button) {
        const wrapper = button.closest('.keyword-wrapper');
        const inputDiv = button.parentElement;

        inputDiv.remove(); // ì‚­ì œ

        const count = wrapper.querySelectorAll('.keyword-input').length;

        // ì´ë¯¸ + ë²„íŠ¼ ìˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€
        const hasPlusButton = Array.from(wrapper.querySelectorAll('button')).some(btn => btn.textContent === '+');

        if (count < 15 && !hasPlusButton) {
            const isSkill = wrapper.id.includes('skill');
            const inputName = isSkill ? 'skill_keywords[]' : 'trait_keywords[]';
            const placeholder = isSkill ? 'ê¸°ìˆ  í‚¤ì›Œë“œ' : 'ì„±í–¥ í‚¤ì›Œë“œ';

            const plusDiv = document.createElement('div');
            plusDiv.className = 'keyword-input';

            const input = document.createElement('input');
            input.type = 'text';
            input.name = inputName;
            input.placeholder = placeholder;

            const button = document.createElement('button');
            button.type = 'button';
            button.textContent = '+';
            button.addEventListener('click', () => {
                if (isSkill) {
                    addSkillKeyword();
                } else {
                    addTraitKeyword();
                }
            });

            plusDiv.appendChild(input);
            plusDiv.appendChild(button);
            wrapper.appendChild(plusDiv);
        }
    }


</script>
<script>
    async function extractKeywords(type) {
        const textareaId = type === 'skill' ? 'requiredSkills' : 'requiredTraits';
        const wrapperId = type === 'skill' ? 'skill-keyword-wrapper' : 'trait-keyword-wrapper';
        const inputName = type === 'skill' ? 'skill_keywords[]' : 'trait_keywords[]';

        const text = document.getElementById(textareaId).value.trim();
        if (!text) {
            alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const formData = new FormData();
        formData.append("text", text);

        try {
            const response = await fetch("http://localhost:8081/extract", {
                method: "POST",
                // mode: "cors",
                body: formData
            });

            const result = await response.json();
            let keywords = result.keywords || [];

            keywords = keywords.slice(0, 15);

            const wrapper = document.getElementById(wrapperId);
            wrapper.innerHTML = ''; // ê¸°ì¡´ í‚¤ì›Œë“œ input ì´ˆê¸°í™”

            keywords.forEach(kw => {
                const inputDiv = document.createElement('div');
                inputDiv.className = 'keyword-input';
                inputDiv.innerHTML = `
                    <input type="text" name="${inputName}" value="${kw}" />
                    <button type="button" onclick="removeKeyword(this)">-</button>
                `;
                wrapper.appendChild(inputDiv);
            });
            if (keywords.length < 15) {
                const plusDiv = document.createElement('div');
                plusDiv.className = 'keyword-input';
                plusDiv.innerHTML = `
        <input type="text" name="${inputName}" placeholder="${type === 'skill' ? 'ê¸°ìˆ  í‚¤ì›Œë“œ' : 'ì„±í–¥ í‚¤ì›Œë“œ'}" />
        <button type="button" onclick="${type === 'skill' ? 'addSkillKeyword()' : 'addTraitKeyword()'}">+</button>
    `;
                wrapper.appendChild(plusDiv);
            }
        } catch (err) {
            console.error("í‚¤ì›Œë“œ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜:", err);
            alert("í‚¤ì›Œë“œ ì¶”ì¶œ ì‹¤íŒ¨");
        }
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector("form");
        if (form) {
            form.addEventListener("submit", function (e) {
                const skillInputs = document.querySelectorAll("#skill-keyword-wrapper input[name='skill_keywords[]']");
                const traitInputs = document.querySelectorAll("#trait-keyword-wrapper input[name='trait_keywords[]']");

                const skillKeywords = Array.from(skillInputs)
                    .map(input => input.value.trim())
                    .filter(val => val)
                    .join(",");

                const traitKeywords = Array.from(traitInputs)
                    .map(input => input.value.trim())
                    .filter(val => val)
                    .join(",");

                document.getElementById("skillKeywordsConcat").value = skillKeywords;
                document.getElementById("traitKeywordsConcat").value = traitKeywords;
            });
        }
    });
</script>

<script th:src="@{/js/auth/fetchWithAuth.js}"></script>
<script type="module">
    import {analyzeJob, restoreOriginalJob} from '/js/chatbot/reviewJobLaw.js';
    import {openReviewModal, applyReview, closeReviewModal} from '/js/chatbot/openReviewModal.js';

    // ì „ì—­ ë“±ë¡
    window.analyzeJob = analyzeJob;
    window.restoreOriginalJob = restoreOriginalJob;
    window.openReviewModal = openReviewModal;
    window.applyReview = applyReview;
    window.closeReviewModal = closeReviewModal;
</script>

</body>
</html>
